# Storybook VRT（ビジュアルリグレッションテスト）ワークフロー
#
# packages/ui/ 配下のファイルが変更された PR で自動実行される。
# Storybook をビルドし、各コンポーネントのスクリーンショットを
# リファレンス画像と比較して意図しない見た目の変更を検出する。
name: Storybook VRT

on:
  pull_request:
    branches: [main]
    # packages/ui/ の変更時のみ実行（apps/web/ のみの変更では不要）
    paths:
      - "packages/ui/**"

jobs:
  vrt:
    name: Visual Regression Test
    runs-on: ubuntu-latest
    # Playwright の公式 Docker イメージを使用（ブラウザがプリインストール済み）
    # バージョンは @playwright/test のバージョンと一致させること
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
    steps:
      - uses: actions/checkout@v4

      # Playwright Docker イメージに unzip が未同梱のため追加（setup-bun に必要）
      - run: apt-get update && apt-get install -y unzip

      # bun をセットアップ（パッケージマネージャー）
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # モノレポ全体の依存関係をインストール（lockfile を厳密に使用）
      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Storybook を静的ビルド（storybook-static/ に出力）
      # VRT では dev サーバーではなくビルド済みの静的ファイルを使用する
      - name: Build Storybook
        run: bun run build-storybook
        working-directory: packages/ui

      # VRT 実行: 各コンポーネントのスクリーンショットをリファレンス画像と比較
      - name: Run VRT
        run: bunx playwright test
        working-directory: packages/ui
        env:
          CI: true

      # テスト失敗時: 差分画像を含むテスト結果をアップロード
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: vrt-report
          path: packages/ui/test-results/
          retention-days: 30

      # 常時: HTML レポートをアップロード（テスト結果の詳細確認用）
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vrt-html-report
          path: packages/ui/playwright-report/
          retention-days: 30
