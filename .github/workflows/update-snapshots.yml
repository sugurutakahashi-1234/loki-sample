# リファレンス画像更新ワークフロー
#
# VRT / E2E のリファレンス画像を CI 環境（Playwright Docker）で再生成し、
# PR を作成する。手動トリガー（workflow_dispatch）専用。
#
# 使い方:
#   1. GitHub Actions の画面から「Run workflow」を実行
#   2. 対象ブランチを選択
#   3. 更新対象（VRT / E2E / 両方）を選択
#   4. 完了後、リファレンス画像を更新する PR が作成される
name: Update Snapshots

on:
  workflow_dispatch:
    inputs:
      target:
        description: "更新対象"
        required: true
        default: "both"
        type: choice
        options:
          - vrt
          - e2e
          - both

permissions:
  contents: write
  pull-requests: write

jobs:
  # スナップショット更新は Playwright Docker コンテナ内で実行
  update:
    name: Update Snapshots
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      # Playwright Docker イメージに unzip が未同梱のため追加（setup-bun に必要）
      - run: apt-get update && apt-get install -y unzip

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # --- VRT ---
      - name: Update VRT snapshots
        if: inputs.target == 'vrt' || inputs.target == 'both'
        run: bun run vrt:update-snapshots
        working-directory: packages/ui
        env:
          CI: true

      # --- E2E ---
      - name: Build application
        if: inputs.target == 'e2e' || inputs.target == 'both'
        run: bun run build
        working-directory: apps/web

      - name: Update E2E snapshots
        if: inputs.target == 'e2e' || inputs.target == 'both'
        run: bun run e2e:update-snapshots
        working-directory: apps/web
        env:
          CI: true

      # 更新されたスナップショットを Artifact として保存
      - name: Upload updated snapshots
        uses: actions/upload-artifact@v6
        with:
          name: updated-snapshots
          path: |
            packages/ui/vrt/screenshots/
            apps/web/e2e/screenshots/

  # PR 作成はコンテナ外で実行（peter-evans/create-pull-request がコンテナ内の git で失敗するため）
  create-pr:
    name: Create Pull Request
    needs: update
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      # Artifact からスナップショットをダウンロードして上書き
      - name: Download updated snapshots
        uses: actions/download-artifact@v7
        with:
          name: updated-snapshots

      - name: Set timestamp
        id: timestamp
        run: echo "value=$(date +'%Y%m%d-%H%M%S')" >> "$GITHUB_OUTPUT"

      # 変更があればブランチを作成して PR を作る
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          branch: chore/update-snapshots/${{ github.ref_name }}/${{ steps.timestamp.outputs.value }}
          commit-message: "chore: CI 環境でリファレンス画像を更新"
          title: "chore: CI 環境でリファレンス画像を更新"
          body: "このPRはCI環境で再生成されたリファレンス画像を含みます。画像の差分を確認してからマージしてください。"
          add-paths: |
            packages/ui/vrt/screenshots/
            apps/web/e2e/screenshots/
