# リファレンス画像更新ワークフロー
#
# VRT / E2E のリファレンス画像を CI 環境（Playwright Docker）で再生成し、
# ブランチにコミット・プッシュする。手動トリガー（workflow_dispatch）専用。
#
# 使い方:
#   1. GitHub Actions の画面から「Run workflow」を実行
#   2. 対象ブランチを選択
#   3. 更新対象（VRT / E2E / 両方）を選択
#   4. 完了後、更新されたリファレンス画像が自動コミットされる
name: Update Snapshots

on:
  workflow_dispatch:
    inputs:
      target:
        description: "更新対象"
        required: true
        default: "both"
        type: choice
        options:
          - vrt
          - e2e
          - both

jobs:
  update-vrt:
    name: Update VRT Snapshots
    if: inputs.target == 'vrt' || inputs.target == 'both'
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - run: apt-get update && apt-get install -y unzip

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build Storybook
        run: bun run build-storybook
        working-directory: packages/ui

      # リファレンス画像を再生成
      - name: Update VRT snapshots
        run: bunx playwright test --update-snapshots
        working-directory: packages/ui
        env:
          CI: true

      # 更新された画像をアーティファクトとして保存（commit ジョブで使用）
      - name: Upload updated snapshots
        uses: actions/upload-artifact@v6
        with:
          name: vrt-snapshots
          path: packages/ui/vrt/screenshots/

  update-e2e:
    name: Update E2E Snapshots
    if: inputs.target == 'e2e' || inputs.target == 'both'
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - run: apt-get update && apt-get install -y unzip

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build application
        run: bun run build
        working-directory: apps/web

      # リファレンス画像を再生成
      - name: Update E2E snapshots
        run: bunx playwright test --update-snapshots
        working-directory: apps/web
        env:
          CI: true

      # 更新された画像をアーティファクトとして保存（commit ジョブで使用）
      - name: Upload updated snapshots
        uses: actions/upload-artifact@v6
        with:
          name: e2e-snapshots
          path: apps/web/e2e/screenshots/

  # Docker コンテナ外でコミット・プッシュ（git の safe.directory 問題を回避）
  commit:
    name: Commit Updated Snapshots
    needs: [update-vrt, update-e2e]
    if: always() && !cancelled() && (needs.update-vrt.result == 'success' || needs.update-e2e.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      # VRT スナップショットをダウンロード
      - name: Download VRT snapshots
        if: needs.update-vrt.result == 'success'
        uses: actions/download-artifact@v5
        with:
          name: vrt-snapshots
          path: packages/ui/vrt/screenshots/

      # E2E スナップショットをダウンロード
      - name: Download E2E snapshots
        if: needs.update-e2e.result == 'success'
        uses: actions/download-artifact@v5
        with:
          name: e2e-snapshots
          path: apps/web/e2e/screenshots/

      # 更新があればコミット・プッシュ
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/ui/vrt/screenshots/ apps/web/e2e/screenshots/
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: CI 環境でリファレンス画像を更新"
          git push
